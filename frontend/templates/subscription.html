{% extends "base.html" %}

{% block title %}Prenumerera{% endblock %}

{% block content %}

<!-- OBS! Styling för subscription sidan finns nu i css:en (längst ner) istället-->

<div class="subscription-page">
  <h1>Starta din SMS-prenumeration</h1>

  <div>
    <h2>Starta Prenumeration</h2>
    <form id="subscription-form">
      <label for="phone_number">Telefonnummer: (använd +46701740615 för test i Playground)</label>
      <input type="text" id="phone_number" name="phone_number" required><br><br>

      <label for="counties">Välj län:</label>
      <select id="counties" name="counties" multiple></select>

      <label for="newspaper_id">Välj tidning:</label>
      <select id="newspaper_id" name="newspaper_id" required></select><br><br>

      <button type="submit">Starta Prenumeration</button>
    </form>

    <div id="klarna-checkout-container"></div> <!-- Klarna-widgeten kommer här -->
    <div id="response"></div>
  </div>
</div>

<!-- FLYTTA UT I EGEN JS.FIl -->

<script>
  async function loadNewspapers() {
    const select = document.getElementById("newspaper_id");
    try {
      const res = await fetch("/subscriptions/newspapers");
      if (!res.ok) throw new Error("Kunde inte hämta tidningar från servern");
      const newspapers = await res.json();
      select.innerHTML = "";
      const defaultOption = document.createElement("option");
      defaultOption.textContent = "Välj en tidning";
      defaultOption.disabled = true;
      defaultOption.selected = true;
      select.appendChild(defaultOption);
      Object.entries(newspapers).forEach(([id, name]) => {
        const option = document.createElement("option");
        option.value = id;
        option.textContent = name;
        select.appendChild(option);
      });
    } catch (err) {
      console.error("Kunde inte hämta tidningar:", err);
    }
  }

  async function loadCounties() {
    const select = document.getElementById("counties");
    try {
      const res = await fetch("/subscriptions/counties");
      const counties = await res.json();

      const addedCounties = new Set();
      Object.entries(counties).forEach(([code, name]) => {
        if (!addedCounties.has(name)) {
          addedCounties.add(name);
          const option = document.createElement("option");
          option.value = code;
          option.textContent = name;
          select.appendChild(option);
        }
      });

      new Choices(select, {
        removeItemButton: true,
        searchEnabled: false,
        placeholderValue: 'Välj län',
        shouldSort: false,
        noResultsText: 'Inget län hittades',
      });

    } catch (err) {
      console.error("Kunde inte hämta länslista:", err);
    }
  }

  window.onload = function() {
    loadCounties();
    loadNewspapers();
  };

  document.getElementById('subscription-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    let phoneNumber = document.getElementById('phone_number').value;
    const counties = Array.from(document.getElementById('counties').selectedOptions)
                      .map(option => parseInt(option.value));
    const newspaper_id = document.getElementById('newspaper_id').value;
    const responseDiv = document.getElementById('response');

    phoneNumber = phoneNumber.trim();
    if (!phoneNumber.startsWith('+46')) {
      phoneNumber = phoneNumber.replace(/^0/, '+46');
    }
    if (!/^\+46\d{9}$/.test(phoneNumber)) {
      responseDiv.innerHTML = `<p class="error">Ogiltigt telefonnummer. Använd formatet +46701234567.</p>`;
      return;
    }

    if (!phoneNumber || counties.length === 0 || !newspaper_id || newspaper_id === "Välj en tidning") {
      responseDiv.innerHTML = `<p class="error">Vänligen fyll i telefonnummer, län och tidning.</p>`;
      return;
    }

    try {
      const response = await fetch('/subscriptions/start-subscription', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          phone_number: phoneNumber,
          counties: counties,
          newspaper_id: parseInt(newspaper_id),
        }),
      });

      const data = await response.json();

      if (response.ok) {
        localStorage.setItem('phoneNumber', phoneNumber);
        localStorage.setItem('klarnaSessionId', data.session_id);

        Klarna.Payments.init({
          client_id: data.client_id,
          client_token: data.client_token
        });

        // Ladda in formulär för "card" (kortbetalning)
        Klarna.Payments.load({
          container: '#klarna-checkout-container',
          payment_method_category: 'pay_now'
        }, function (res) {
          if (res.show_form) {
            console.log('Kortbetalningsformulär laddat');
            responseDiv.innerHTML = `<p>Fyll i dina kortuppgifter och klicka på "Bekräfta köp".</p>`;
          } else if (res.error) {
            responseDiv.innerHTML = `<p class="error">Fel vid laddning av betalningsformulär: ${res.error}</p>`;
          }
        });

        // Skapa riktig "Betala" knapp
        if (!document.getElementById('klarna-authorize-click')) {
          const payBtn = document.createElement('button');
          payBtn.id = 'klarna-authorize-click';
          payBtn.textContent = 'Bekräfta köp';
          payBtn.className = 'klarna-authorize-button';

          payBtn.addEventListener('click', async () => {
            try {
              const authResult = await Klarna.Payments.authorize(
                { payment_method_category: 'card' },
                {}
              );

              if (authResult.approved) {
                console.log('Betalning godkänd');
                // Skicka till din server för att skapa prenumeration
                const sessionId = localStorage.getItem("klarnaSessionId");
                const confirmation = await fetch('/subscriptions/prenumeration-startad', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    status: "AUTHORIZED",
                    session_id: sessionId,
                    authorization_token: authResult.authorization_token || "fake-token-123"
                  }),
                });

                if (confirmation.redirected) {
                  window.location.href = confirmation.url;
                } else {
                  const html = await confirmation.text();
                  document.documentElement.innerHTML = html;
                }

              } else {
                console.error('Betalningen nekades');
                responseDiv.innerHTML = `<p class="error">Betalningen blev inte godkänd. Försök igen.</p>`;
              }
            } catch (err) {
              console.error('Authorize-fel:', err);
              responseDiv.innerHTML = `<p class="error">Ett fel inträffade: ${err.message}</p>`;
            }
          });

          document.querySelector('#klarna-checkout-container').after(payBtn);
        }

      } else {
        responseDiv.innerHTML = `<p class="error">Fel: ${data.error || "Okänt fel"}</p>`;
      }
    } catch (error) {
      console.error("Fetch error:", error);
      responseDiv.innerHTML = `<p class="error">Något gick fel: ${error.message}</p>`;
    }
  });
</script>


{% endblock %}
